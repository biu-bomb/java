# BIN

``bin-log``以二进制信息记录数据库执行的数据修改操作，``mysql``不论选用哪种存储引擎，都会记录``bin-log``日志。

## 使用场景

| 场景     | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| 主从复制 | 1. ``master``产生``bin-log``<br />2. ``bin-log``传输到``slave``<br />3. ``slave``回放``bin-log`` |
| 数据恢复 | 直接回放``bin-log``恢复数据                                  |

## 刷盘时机

> 通过``sync_binlog``控制``bin-log``刷盘

| sync_binlog | description        |
| ----------- | ------------------ |
| ``0``       | 系统控制           |
| ``1``       | 每次提交都需要刷盘 |
| ``n``       | 每``n``个事务刷盘  |

## 日志格式

| 格式          | 说明       | 优点                                                         | 缺点                              |
| ------------- | ---------- | ------------------------------------------------------------ | --------------------------------- |
| ``STATEMENT`` | 命令记录   | 命令级别，降低日志量，节约``IO``                             | ``sysdata()``等命令导致数据不一致 |
| ``ROW``       | 行数据记录 | 精确数据，严格一致                                           | 针对每一行数据，数据量太大        |
| ``MIXED``     | 混合记录   | 默认``STATEMENT``，会产生不一致数据的命令采用``ROW``<br />取长补短 |                                   |

# REDO

| 名词    | 解析                                       |
| ------- | ------------------------------------------ |
| 持久性  | 为了保证``持久性``，每次数据修改都应该记录 |
| ``WAL`` | ``Write Ahead Logging``，先写日志后落盘。  |

## buffer

![img](../.imgs/redo_buffer)

- 如果每次数据变更都要直接刷新磁盘，``IO``消耗太大，因此都是先写入``buffer``，然后再进行文件数据同步
- 用户空间数据刷盘，需要先复制到内核空间缓冲区，再刷写到系统磁盘上

## 文件同步

> 通过``innodb_flush_log_at_trx_commit``控制``os-buffer``同步到文件。

| innodb_flush_log_at_trx_commit | description |
| ------------------------------ | ----------- |
| 0                              |             |
| 1                              |             |
| 2                              |             |

