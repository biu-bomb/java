# Redis过期检测

## 数据存储

```c
typedef struct redisObject {
    unsigned lru:22;
} robj;
```

``Redis``存储数据结构，外包装都是使用``redisObject``进行管理。其中的``lru``管理的是数据插入时的时间戳。

> 因为``redisServer``中存储有时间戳的缓存，因此数据过期并非是高精度的时间过期。
>
> 更高精度的时间获取都是直接从系统获取，而非取缓存时间戳。

## 过期时间

```c
typedef struct redisDb{
    dict *expires;
} redisDb;
```

``redisDb``的核心数据存储就是一个``dict``，存储对应数据。对于过期时间的管理，同样也是如此。

相较于数据的``k-v``，``exipres``中存储的是``expire-keys``的形式，直接通过过期时间查询应该过期的键值。

## 过期检测

| 时间     | 说明                |
| -------- | ------------------- |
| 插入时间 | ``lru``             |
| 过期时间 | ``lru + expire``    |
| 存活时间 | ``timestamp - lru`` |

当存活时间大于过期时间，数据就应该被删除。

# Redis过期删除

| 删除方式 | 操作描述                       | 内存影响                                  | CPU影响                                   | Redis支持 |
| -------- | ------------------------------ | ----------------------------------------- | ----------------------------------------- | --------- |
| 定时删除 | 每次插入数据，生成定时删除任务 | 过期直接回收，内存友好                    | 大量定时任务，CPU消耗大                   | 否        |
| 惰性删除 | 查询时候检测时间，过期删除     | 大量过期数据未回收，内存消耗大            | 刚好时候检测，CPU友好                     | 是        |
| 周期删除 | 周期性检测数据，过期删除       | 周期小，同定时删除<br >周期大，同惰性删除 | 周期小，同定时删除<br >周期大，同惰性删除 | 是        |

# 过期持久化

| 持久化方式  | 操作说明                                                     |
| ----------- | ------------------------------------------------------------ |
| RDB         | 快照序列化，自动忽略过期数据                                 |
| ``AOF``     | 跟随服务命令，过期数据并不特殊处理，服务器删除时候补充``DEL``命令 |
| ``AOF``重写 | 重写的时候忽略过期数据                                       |

# 主从复制过期

| 服务器     | 操作                                                      |
| ---------- | --------------------------------------------------------- |
| ``master`` | 主服务器发现消息过期，直接``DEL``并转发命令到 从服务器    |
| ``slave``  | 即使发现数据过期，也不操作，等待主服务器``DEL``命令才删除 |

