#  CLOSE_WAIT 或 TIME_WAIT 堆积

![img](../.imgs/CLOST_WAIT)

> 如图所示，如果大量出现``CLOSE-WAIT``或``TIME-WAIT``，根本原因在于没能够完成状态的快速跳变。

## TIME-WAIT

## 问题分析

| 原因   | 分析                                                         |
| ------ | ------------------------------------------------------------ |
| 丢包   | 丢包导致状态不跳变<br />存在拥塞控制，少量堆积属正常现象，不可能出现大量堆积 |
| 短连接 | 大量短连接，使用完立即关闭                                   |

## 解决办法

> 配置文件：``/etc/sysctl.conf``
>
> 生效命令：``/sbin/sysctl -p``

| property                          | default          | description                                     |
| --------------------------------- | ---------------- | ----------------------------------------------- |
| ``net.ipv4.tcp_max_syn_backlog``  | ``1024``         | ``SYN``队列长度，增大队列长度，容纳更多网络连接 |
| ``net.ipv4.tcp_syncookies``       | ``0``            | ``SYN``队列溢出，采用``cookie``处理             |
| ``net.ipv4.tcp_tw_reuse``         | ``0``            | 将``TIME-WAIT``socket用于新``TCP``连接          |
| ``net.ipv4.tcp_orphan_retries``   | ``7``            | 丢弃连接前，重试次数                            |
| ``net.ipv4.tcp_keepalive_time``   | ``2 * 60 * 60s`` | ``keepalive``探测周期                           |
| ``net.ipv4.tcp_keepalive_probes`` |                  | 丢弃连接前，探测失败次数                        |
| ``net.ipv4.tcp_keepalive_intvl``  | ``75s``          | 探测周期                                        |

# CLOSE-WAIT

## 问题分析

> ``CLOST-WAIT``大量堆积，说明后续挥手流程逻辑不完整。

| 原因           | 分析                                                         |
| -------------- | ------------------------------------------------------------ |
| 网络丢包       | 后续挥手信号包丢失，状态迟迟无法跳变。<br />因为拥塞控制存在，并不会导致大量堆积，少量堆积属于正常现象。 |
| 客户端逻辑缺失 | 客户端逻辑缺失，对后两次挥手不处理。                         |
| 客户端关闭     | 客户端关闭，无法应答处理。                                   |
| 服务端逻辑缺失 | 服务端逻辑缺失，不进行后续挥手操作。                         |

## 解决办法

排查代码。