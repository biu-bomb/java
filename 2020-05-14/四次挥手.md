# 四次挥手

![img](../.imgs/bye4)

| order | client                                                       | server                                                       |
| ----- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1     | FIN=1,seq=u<br />发送，从``ESTAB-LISHED``转为``FIN-WAIT-1``  | 服务端接收客户端关闭请求<br />等待发送中数据完全发送         |
| 2     | 收到响应，关闭``client->server``通道，等待服务端连接关闭<br />``FIN-WAIT-1``转到``FIN-WAIT-2`` | ``ACK=1,seq=v,ack=u+1``<br />发送，``ESTAB-LISHED``转为``CLOSE-WAIT`` |
| 3     | 收到客户端连接关闭，关闭服务端连接<br />``FIN_WAIT-2``转到``TIME-WAIT`` | FIN=1,ACK=1,seq=w,ack=u+1<br />``CLOSE-WAIT``转到``LAST-ACK`` |
| 4     | ACK=1,seq=u+1,ack=w+1                                        | 收到关闭连接，关闭服务端连接                                 |

# 问题

## 为什么连接三次握手，关闭需要四次挥手

因为连接的时候两边通道都是新建，一一对应即可。

断开的时候，一方通道关闭，但是另一方通道可能还在进行数据传输，无法直接关闭。

只有接收到信号，等待发送中的数据到达，同时暂停新数据发送；清空通道数据以后才能正确关闭。

## TIME-WAIT为什么要等待2MSL

> <font color='red'>MSL：最长报文段寿命</font>

如果直接返回不等待，如果发生丢包，服务端就会不停的发送``FIN``等待确认。

``TIME-WAIT``为了保证在丢包情况下重发``ACK``。

## 连接建立，客户端故障怎么办

``TCP``有一个保活计时器，每次客户端请求，都会重置该计时器。

计时器时间周期默认为2小时，如果两小时以内没有接收到客户端请求，每隔75秒就会发送探测报文段。

连续探测10次没有响应，就会关闭该连接，节约服务器资源。