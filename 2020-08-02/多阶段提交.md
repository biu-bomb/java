# 提交角色

| 角色            | 功能                       |
| --------------- | -------------------------- |
| ``coordinator`` | 协调者，协调各执行者的动作 |
| ``worker``      | 执行者，每个事务节点       |

# 两阶段提交

## 提交过程

- 表决阶段

  执行者表决，向协调者表明自己的状态；提交或者取消。

- 提交阶段

  当且仅当全部执行者都表决提交，通知全部执行者执行提交操作。

## 提交缺点

- 同步阻塞：执行事务占有资源，第三方访问公共资源被阻塞。
- 单点故障：第一阶段完成后协调者故障，导致资源阻塞不释放。
- 数据差异：第二阶段提交过程中，部分节点丢包未收到提交确认，导致数据不一致。

## 残留问题

- 当协调者和执行者同时出错，事务完整性无法保证。

# 三阶段提交

- CanCommit

  检测执行者状态，是否能够进行事务执行。

- PreCommit

  - YES: 预执行事务，返回YES，下一阶段commit
  - NO: 不能够执行事务，返回NO，下一阶段abort
  - Timeout: 超时，下一阶段abort

- DoCommit

  - commit: 通知执行者提交事务
  - abort: 通知执行者回滚事务

---

相对于二阶段而言

- CanCommit检测资源不阻塞
- PreCommit超时机制不阻塞

遗留问题

- DoCommit阶段超时默认commit，如果abort丢包，会导致数据不一致 