# 基础哈希

$$
y = h(x)
$$

哈希就是映射，唯一的数据得到唯一的映射。

哈希用于检索数据，能够在$O(1)$时间内完成查询；正是由于存储的必要，哈希最后都以数值形式锁定存储位置。

## 哈希碰撞

受限资源和算法，现实中的哈希并无法达到理想中的效果。

对于相同的数据，受限情况下，可能会计算出相同的哈希值，这就是哈希碰撞。

这种时候需要进行二次的区分操作，常用办法

- 开放寻址法：对于碰撞的数据再次哈希
- 链地址法：链表+二次比对

## 扰动函数

主要受限于存储空间的大小，计算得到的离散哈希值，映射到存储空间的时候，可能存在分布不均的情况。

因此，对存储空间进行取模之后，加上扰动函数能够使得数据分布更均匀，避免资源聚集。

## 基础哈希局限

基础的哈希，只是最朴素的思路展现，缺乏更高层级的管理手段，伴随存储和计算的相互纠缠。

最核心的问题在于：**当存储空间进行扩容的时候，原空间的大多数哈希面临失效的情况**

# 一致性哈希

> 一致性哈希可以类比于开放寻址法，但是核心不是具体的碰撞，而是数据的归纳范围。
>
> 更关键的是，它将哈希和存储确实的分开了，不再针对存储本身，而是使用节点来封装具体存储这一功能。

![img](../.imgs/498077-20160822172408386-366341651.png)

## 哈希算法

为了大量数据的存储，也为了节点的扩充，整体的哈希范围为$[0, 2^ {23} - 1]$​。

## 存储节点

假设顺序存在三个节点$A(a), B(b), C(c)$，其中$B$的存储范围为$B(a, b]$，$C$的数据范围为$C(b, c]$。

就这样，每个节点负责一定的数据区间的存储，就能够将整体的存储分配到多个节点上。

同时，如果需要进行扩容，只需要在环上进行节点的插入即可。

## 虚拟节点

一般情况下，环上的节点需要均匀分布，以达到数据分布均衡。

但是由于存储节点的性能差异，有时候需要某些节点进行更多的数据存储。

虽然扩大承载范围是一个办法，但是对于不连续的空间分配并不生效。

这个时候，采用虚拟节点作为具体节点的分身，存储的时候转接到具体节点即可。

> ## 增加节点
>
> 在$A(a), C(c)$中增加节点$B(b)$，则$A(a)$节点不受影响，但是$C(c)$节点中的$(a, b]$区间数据需要迁移到$B(b)$节点。
>
> ## 删除节点
>
> $A(a), B(b), C(c)$节点中，删除$B(b)$节点，其中的$(a, b]$区间数据需要转移到$C(c)$节点。

---

## 哈希指标

| 哈希指标 | 指标说明                                                     |
| -------- | ------------------------------------------------------------ |
| 均衡性   | 哈希均匀分配在指定的地址空间中                               |
| 单调性   | 随着地址空间增大(减小)，哈希映射的范围能够跟随变化           |
| 分散性   | 从系统角度，对不同资源应该分散存储在不同地方，相同资源存储同一地方<br />由于终端的可见缓冲范围不同，可能将不同资源存储同一地方，相同资源存储在不同地方 |
| 负载     | 负载是从存储节点看分散性问题：同一缓冲区可能映射不同资源类型 |



