# RDB

## 保存方式

|            | save                         | bgsave                               |
| ---------- | ---------------------------- | ------------------------------------ |
| ``IO``类型 | 同步                         | 异步                                 |
| 是否阻塞   | 是，阻塞主进程               | 是，阻塞``fork``子进程               |
| 复杂度     | ``O(n)``                     | ``O(n)``                             |
| 优点       | 不消耗额外内存               | 不阻塞主进程，可以同时执行客户端命令 |
| 缺点       | 阻塞主进程，不响应客户端命令 | 额外``fork``进程，消耗内存           |

## 写入时机

| save     | bgsave   |
| -------- | -------- |
| 命令触发 | 定时触发 |

```properties
# {duration}时间段内，操作次数达到{ops}触发自动保存
save {duration} {ops}
# 是否启用压缩存储
rdbcompression yes
# CRC64数据校验，增加10%性能消耗
rdbchecksum yes
# 日志文件名称
dbfilename redis.rdb
# 日志存放目录
dir .
```

## 优缺点

| 优点                                                         | 缺点                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1. 结构紧凑，文件体积小<br />2. ``fork``子进程，不阻塞主进程命令执行<br />3. 数据恢复快 | ``fork``子进程时候使用主进程数据备份<br />保存过程中数据修改不会被感知，造成数据不准确 |

# AOF

## 保存方式

| 文件写入                         | 文件重写                                                 |
| -------------------------------- | -------------------------------------------------------- |
| 每次命令直接拼接到``aof_buffer`` | 文件过大，重做``aof``<br />精简命令，剔除过期数据操作... |

## 文件同步

| 触发方式     | 功能描述                                                     | 数据丢失             |
| ------------ | ------------------------------------------------------------ | -------------------- |
| ``always``   | 每次写入都同步刷写到磁盘文件<br />数据完整性较好，但是性能较差 | 最多丢失一条命令数据 |
| ``everysec`` | 每秒进行日志文件同步                                         | 丢失一秒数据         |
| ``no``       | 由操作系统决定刷写频率                                       | 上次同步到现在的数据 |

## 优缺点

| 优点                                                         | 缺点                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1. 数据安全：直接命令写入，数据安全<br />2. 写性能高：直接命令写入，无磁盘寻址<br />3. 格式可读：误操作恢复 | 1. 文件较大：文本命令存储，文件较大<br />2. 写性能低：每秒``fsync``消耗``io``(性能很高，只是相较而言) |

# 对比

|            | RDB                                | AOF                 |
| ---------- | ---------------------------------- | ------------------- |
| 启动优先级 | 低                                 | 高(优先``AOF``恢复) |
| 日志体积   | 小(二进制快照)                     | 大(文本命令)        |
| 恢复速度   | 快(二进制数据)                     | 慢(文本命令重放)    |
| 数据安全   | 丢、脏数据(``bgsave``时候数据差异) | 丢数据(策略相关)    |

