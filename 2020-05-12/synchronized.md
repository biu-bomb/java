# 冲突管理

进程中的多个线程，需要配合以完成服务功能，不少情况下，需要线程相互配合。

| 调配手段              | 原理解释                                            |
| --------------------- | --------------------------------------------------- |
| ``CAS``或其他条件检测 | 条件检测，使``CPU``空转，错开数据竞争               |
| 状态依赖              | 使用``yield``或者``wait``、``notify``，调配线程状态 |
| ``mutex``             | 操作系统管理，严格控制线程状态                      |

## 管理优劣

| 管理方式  | 优势                                      | 缺点                                                         |
| --------- | ----------------------------------------- | ------------------------------------------------------------ |
| ``CAS``   | 无``cpu``上下文切换<br />无上下文切换消耗 | 空耗``CPU``<br />降低吞吐量                                  |
| 状态依赖  | 节省``cpu``消耗，精准调度                 | 管理复杂``notiy``和``notifyAll``不能精准打击                 |
| ``mutex`` | 内核调度，无需管理                        | 内核态管理<br />内核态用户态切换消耗大<br />进程上下文切换消耗大 |

> - ``CAS``
>   - 优点：少量并发时候，能够减少线程上下文切换，提高并发处理效率
>   - 缺点：大量并发造成``CPU``浪费，阻塞其他业务执行
> - ``mutex``
>   - 优点：同类线程一时只会有一个活跃线程，严格降低并发，不影响其他业务
>   - 缺点：用户态和内核态切换，复制进程到内核空间，消耗较大

# synchronized

> 老版本中，业务层无法严格保证线程间的数据准确性，因此<font color='red'>业务层条件检测</font>不可靠。
>
> 随着版本更新迭代，``JVM``逐渐支持该操作，并在``jdk1.5``后加入``concurrent``并发包。
>
> 在``jdk1.6``使用``CAS``方法进行了``synchronized``的锁的优化；优化后效率不低于``Lock``

| 锁等级   | 场景             | 锁实现                                                       | 锁升级                              |
| -------- | ---------------- | ------------------------------------------------------------ | ----------------------------------- |
| 无锁     | 无锁             | 无                                                           | 无                                  |
| 偏向锁   | 频繁单一线程访问 | 检查锁对象的``Mark Word``<br />如果是当前线程的线程的``ID``，直接执行逻辑<br />如果可设置，设置为当前线程``ID``，执行逻辑 | ``Mark Word``非当前线程``ID``       |
| 轻量级锁 | 少量线程访问     | 复制锁对象头到自身栈帧，``CAS``设置自身线程``ID``<br />设置成功获取锁，执行逻辑 | ``CAS``循环超过指定次数或者指定时间 |
| 重量级锁 | 大量并发         | 交给操作系统管理``mutex``                                    | -                                   |



![在这里插入图片描述](../.imgs/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p6dGlfZXJsaWU=,size_16,color_FFFFFF,t_70)